<!DOCTYPE html>
<html>
<head>
	<title>云印API接口</title>
	<meta charset="utf-8">
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
	<style type="text/css">
	html {
	margin:0;
	height:100%;
	width:100%
}
body {
	background-color:#57c3ea;
	color:#EEE;
	text-align:center;
	position:relative;
	overflow-x:hidden;
	width:100%;
	min-height:98%
}
h1,h2 {
	color:#FFF;
	white-space:nowrap
}
h3,h4,h5,h6 {
	color:#fefefe
}
a {
	text-decoration:none
}
.input:active,.input:hover,.input:focus {
	color:#57c3ea;
	font-weight:bolder;
	background:#fefefe
}
.input[disabled] {
	cursor:wait
}
#img,.input {
	padding:10px 15px 5px 15px;
	width:75%;
	margin-top:1%;
	margin-bottom:2%;
	font-family:Lato,Helvetica,Arial,sans-serif;
	font-size:1.5em;
	line-height:1.8em;
	background-color:transparent;
	color:#FFF;
	border:4px solid #fefefe;
	border-radius:6px;
	box-shadow:none;
	-webkit-transition:border .25s linear,color .25s linear,background-color .25s linear;
	transition:border .25s linear,color .25s linear,background-color .25s linear
}
#img,.code {
	width:38%;
	padding:1px;
	vertical-align:middle;
	display:inline-block
}
#codeArea {
	height:80px;
	display:none
}
#img {
	margin-right:1%;
	border:0
}
.code {
	margin-left:1%;
	padding-left:10px
}
#tip {
	color:#ec7329;
	font-size:larger;
	font-weight:bolder;
	text-decoration:underline
}
#<?=isset($reg)?'auth':'reg'?>form {
	display:none
}
	</style>
</head>
<body>
 <h1>云印API登录</h1> 
  <div id="tip">
   <?=isset($msg) ? $msg : ''?>
  </div> 
  <form id="authform" method="post" onsubmit="return checkform();"> 
   <input name="name" type="text" class="input" placeholder="学号" id="number" onchange="checknumber()" required="" /> 
   <input name="password" type="password" class="input" placeholder="密码" id="password" required="" /> 
   <div id="codeArea"> 
    <img id="img" src="" /> 
    <input name="code" type="text'" class="code input" placeholder="验证码" id="code" /> 
   </div> 
   <button class="input" type="submit" id="submit">验证</button> 
  </form> 
  <form id="regform" method="post" action="/api/register" onsubmit="return checkreg();"> 
   <h6>第一次使用云印？我们推荐您设置独立的密码,这样更加安全！<br />如果您跳过设置,将会使用验证密码作为云印密码!</h6> 
   <input name="password" type="password" class="input" placeholder="新的密码" id="reg_password" required="" /> 
   <input type="password" class="input" placeholder="确认密码" id="repassword" onblur="checkreg()" required="" /> 
   <button class="input code" type="submit" id="reg">设置密码</button> 
   <a class="input code" href="/api/register">跳过设置</a> 
  </form> 
<script src="http://apps.bdimg.com/libs/jquery/1.7.2/jquery.min.js"></script>
<script >
function showtips(msg) {
	$('#tip').html(msg).show();
}

var reg = /^(\d{7})|(\d{10})$/;
function checknumber() {
	var number = $('#number').val();
	name = number.trim();
	if (!reg.test(number)) {
		showtips("学号格式不对哦，请检查一下学号^_^");
		document.getElementById("number").focus();
		return false;
	}
	$.post('/school/number', {
		'number': number
	},
	function(data) {
		if (data.status) {
			var info = data.info;
			for (var s in info) {
				if (info[s] != 0) {
					$.get('/school/' + s + '/code/',
					function(data) {
						if (data.status == 1) {
							$('#img').attr('src', data.info['img']).click(function() {
								$.get('/school/' + s + '/code/',
								function(data) {
									if (data.status == 1) {
										$('#img').attr('src', data.info['img']);
									}
								});
							});
							$('#codeArea').show(200);
							$('#code').attr('required', 'required');

							$.get('/school/' + s,
							function(data) {
								if (data.status == 1) {
									var school = data.info;
									showtips(school['name'] + ':首次登录用<a target="_blank" href="' + school['verifyurl'] + '">' + school['verify'] + '</a>密码验证')
								}

							});
						}
					});
				} else {
					$('#codeArea').hide(200);
					$('#code').removeAttr('required');
					showtips('');
				}

			};
		} else {
			showtips("学号好像不是所支持的学校，请检查一下学号^_^");
			return false;
		}
	});
	showtips('');
}
function enable() {
	$('#authform').removeAttr('disabled');
	$('#password').removeAttr('disabled');
	$('#password').removeAttr('disabled');
	$('#code').removeAttr('disabled');
	$('#submit').text('验证').removeAttr('disabled');
}
function checkform() {
	$('#authform').attr('disabled', 'disabled');
	$('#submit').text('验证中...').attr('disabled', 'disabled');
	var number = $('#number').attr('disabled', 'disabled').val();
	number = number.trim();
	if (!reg.test(number)) {
		enable();
		showtips("学号格式不对哦，请检查一下学号^_^");
		document.getElementById("number").focus();
		return false;
	}
	var password = $('#password').attr('disabled', 'disabled').val();
	var code = $('#code').attr('disabled', 'disabled').val();
	var data = {
		'number': number,
		'password': password.trim()
	};
	if (code) {
		data['code'] = code;
	}
	$.post('/auth/', data,
	function(resp) {

		switch (resp.status) {
		case 1:
			//登录成功
			showtips('');
			break;

		case 2:
			//注册
			$('h1').text('设置云印密码');
			$('#authform').hide(200);
			$('#regform').show(400);
			showtips('');
			break;

		case 0:
		case - 1 : showtips(resp.info);
			enable();
			break;
		default:
			enable();
			showtips('请求异常');
		}

	});
	return false;
}
function checkreg() {
	var password = $('#reg_password').val();
	var repassword = $('#repassword').val();
	if (password.trim() == repassword.trim()) {
		$('#reg_password').val(password.trim());
		showtips('');
		return true;
	} else {
		showtips('两次密码不一样');
		return false;
	}
}
</script>
</body>
</html>